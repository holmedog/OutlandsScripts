#Part of the attack routine is to call a Razor Dress routine named "bow".  
#   If you do not have that it will not stop the script but it is 
#   a good idea to have one in case you unequip weapon

#Set this to 1 if you want to kill one target at a time.  Anything else tries to spread damage by swapping target every 2.5s.  Should be 1 for Herding chars in particular
#SPECIAL NOTE: Having Poisonining greater than 50 overwrites this always as that would be a bad choice
@setvar targetLock 1

#Set this to 1 if you want to throw self overboard if a ship repair kit is on the deck
@setvar triggerOverboard 0

#Set this to 1 if you want to only allow repair kits for 2 mins after embarking
@setvar repairLockdown 0

#Set this to 1 if you want to keep up buffs for Reactive Armour and Magic Reflect
@setvar defensiveBuffs 0

#Set this to 1 if you want to simulate always being boarded on NPC ship for testing reasons
@setvar alwaysBoarded 0


##################################################################################
##################################################################################
##################################################################################
##############              No setup below here                ###################
##################################################################################
##################################################################################
##################################################################################

clearsysmsg 

#Timers.  We used to do these on an if exists basis, but it fubard too much stuff if you leave client open forever
createtimer 'petAttack' 
settimer 'petAttack' 0
createtimer 'repairTimer'
settimer 'repairTimer' 0
createtimer 'discoTimer'
settimer 'discoTimer' 5000
createtimer 'repairBoat'
settimer 'repairBoat' 8000
createtimer "shroomy"
settimer "shroomy" 61000
createtimer 'buffDisco'
settimer 'buffDisco' 300000
createtimer 'buffProvo'
settimer 'buffProvo' 300000
createtimer 'buffPeace'
settimer 'buffPeace' 300000
createtimer 'buffBeg'
settimer 'buffBeg' 300000 
createtimer 'bardLock'
settimer 'bardLock' 0
createtimer "aid time"
settimer "aid time" 8000
createtimer 'RepairHull'
settimer 'RepairHull' 0
createtimer 'buffTaste'
settimer 'buffTaste' 15000
createtimer 'newTargetCheck'
settimer 'newTargetCheck' 15000
createtimer 'spiritSpeakCheck'
settimer 'spiritSpeakCheck' 15000
createtimer 'foodCheck'
settimer 'foodCheck' 120000
createtimer 'crookCheck'
settimer 'crookCheck' 120000
createtimer 'crewHealing'
settimer 'crewHealing' 120000
createtimer 'onBoard'
settimer 'onBoard' 120000
createtimer 'painSpkeTimer'
settimer 'painSpkeTimer' 120000
createtimer 'poisonStrikeTimer'
settimer 'poisonStrikeTimer' 120000
createtimer 'vampTimer'
settimer 'vampTimer' 120000
createtimer 'dressTimer'
settimer 'dressTimer' 120000

#Clear lastt t arget from last run - this can cause a weird bug
unsetvar 'lastserial' 

#Create list of instrument types and dclick if found
removelist 'instrumentTypes'
createlist 'instrumentTypes'
pushlist 'instrumentTypes' 10245
pushlist 'instrumentTypes' 3762
pushlist 'instrumentTypes' 3740
pushlist 'instrumentTypes' 3742
pushlist 'instrumentTypes' 3763

#Create list of reagents
createlist regTypes
clearlist regTypes
@pushlist 'regTypes' 'Blood Moss'
@pushlist 'regTypes' 'Black Pearl%s%'
@pushlist 'regTypes' 'Ginseng'
@pushlist 'regTypes' 'Garlic'
@pushlist 'regTypes' 'Sulfurous Ash'
@pushlist 'regTypes' "Spider's Silk" 
@pushlist 'regTypes' 'Nightshade' 
@pushlist 'regTypes' 'Mandrake Root%s%' 
# ' for formatting reasons

#Loop through instruments and dclick one
foreach instrumentType in 'instrumentTypes'
    dclicktype instrumentType
endfor

#Set boarded state - 1=boarded NPC 0=on our ship
@setvar 'boardState' 0
#Set up tracking sate 1=tracking 0=not
@setvar 'trackState' 0
#set up var to check if we have enemies in range
@setvar 'closeEnemy' 0
#set up blue tracking option
@setvar 'blueSighted' 0

#set pets if they exist
if skill "Veterinary" > 50 and followers >= 1
    overhead "Target pet 1" 
    setvar! pet1
    overhead "Target pet 2"
    setvar! pet2
    overhead "Target pet 3"
    setvar! pet3 
endif   

overhead "Select your Tillerman"
setvar! tillerDude
wait 350
dclick tillerDude
wait 350

#do camping buff at least once regardless of buff status
#camping buff
if skill "Camping" > 50 
    if not findtype "kindling" backpack
        say "Need more kindling" 
        wait 355
        say "Need more kindling" 
        wait 355
        say "Need more kindling" 
        wait 355
    endif

    if not findtype "campfire" true
        dclicktype "kindling" backpack
        wait 350
        while insysmsg "You fail to ignite"
            wait 3000    
            dclicktype "kindling" backpack
            wait 350
        endwhile
    endif
    wait 600
endif

     
if followers > 1
    say "All guard me"
endif   


while not dead
    #put in a pause so we dont spam 
    wait 350    
    
    if alwaysBoarded = 1
        @setvar boardState 1
    endif
    
    
    ###############                                             ###############
    ###############Start routines that keep us alive or set vars###############
    ###############                                             ###############   
    
    #make sure a cursor does not exist from before
    if targetexists
        hotkey "Cancel Current Target"
        wait 350
    endif   
    
    #Check if we are on NPC ship
    if insysmsg "You board the ship"
        @setvar 'boardState' 1
        settimer onBoard 0
    endif
    
    #dont let this guy die routine
    if hp < 55 
        overhead 'Drinking heal!'
        potion "heal"
        wait 200
    endif
    #Magery Survival
    if skill "Magery" > 50
        #we cast arch here bc it probably hit whole crew
        if poisoned 'self'
            cast 'Arch Cure'
            waitfortarget 1755
            target 'self'
            wait 666
        endif
        if diffhits > 18
            cast "greater heal"
            wft 3500
            target self
            wait 650 
        endif   
        #Eat a magic mushroom if we have 
        #25  less mana than full
        if mana < 70 and timer "shroomy" >= 61000
            dclicktype '29012'
            overhead 'Mushroom Power!'
            settimer "shroomy" 0
        endif
    endif
    # Bandage Survival
    if skill 'Healing' > 50
        if insysmsg 'You begin applying the bandages'
            settimer 'aid time' 0
        endif
        if diffhits > 10 and timer 'aid time' > 10250 
            hotkey 'bandage self'
            settimer 'aid time' 0
        endif
        if insysmsg 'You begin applying the bandages'
            settimer 'aid time' 0
        endif
    endif
    #Pet Healing    
    if skill "Veterinary" > 50 and followers >= 1 and diffhits <= 10
         if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            dclicktype 3617
            wft 2500
            target pet1         
            wait 250
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
         endif
         if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            dclicktype 3617
            wft 2500
            target pet2       
            wait 250 
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
         endif
         if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            dclicktype 3617
            wft 2500
            target pet3      
            wait 250  
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
         endif       
        #We checked all - pause for spam
        if timer 'crewHealing' > 5050 and skill 'Healing' <= 50
            settimer 'crewHealing' 1000
        endif
    endif
    #Crew Healing
    if skill 'Healing' > 50 and diffhits <= 10
        if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            gumpresponse 20 1722920179
            wait 250 
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
        endif
        if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            gumpresponse 21 1722920179
            wait 250 
            if insysmsg 'You begin applying the bandages'   
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
        endif
        if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            gumpresponse 22 1722920179
            wait 250 
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
        endif
        if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            gumpresponse 23 1722920179
            wait 250 
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
        endif
        if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            gumpresponse 24 1722920179
            wait 250 
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
        endif
        if timer 'aid time' > 10250 and timer 'crewHealing' > 5050
            gumpresponse 25 1722920179
            wait 250 
            if insysmsg 'You begin applying the bandages'
                settimer 'aid time' 4500
                settimer 'crewHealing' 0
            endif
        endif  
        #We checked all - pause for spam
        if timer 'crewHealing' > 5050
            settimer 'crewHealing' 1000
        endif
    endif
    
    ###############                                           ###############
    ###############   Start buff routines                     ###############
    ###############                                           ###############
    #Throw self overboard if a ship repair kit is on the deck
    if 'triggerOverboard' = 1
        if findtype 25758 ground any any 8
            say "So long fair world"
            wait 500
            say "[throwselfoverboard"
            stop
        endif
    endif
    
    
    #Tracking Routine - Turn it on if we have not yet
    if skill 'Tracking' > 80 and 'trackState' = 0
        while not insysmsg "You will receive"
            hotkey 'Tracking'
            gumpresponse 6 4267467659
            wait 500
        endwhile    
        gumpclose 4267467659
        @setvar 'trackState' 1
    endif
    
    #food buff routine
    if timer 'foodCheck' > 60000 and not findbuff 'food satisfaction'
        if not findtype tray backpack
            say  "I am out of food!"
            wait 500
            say  "I am out of food!"
            wait 500
            say  "I am out of food!"
            wait 500
        else
            dclicktype tray backpack
        endif
        settimer 'foodCheck' 0
    endif
    
    #Follower Routine
    if skill "Necromancy" > 80 or skill "Spirit Speak" > 80
        if followers < 4 and mana > 50
            #Lost a fire elem, resummon
            settimer "bardLock" 0
            if skill "Necromancy" > 80
                say "[VengefulSpirit"
                wait 1000
            endif
            cast 'Fire Elemental'
            wait 6000
            say "All Guard Me"
            #rebuff to get pet buffed
            if mana > 15 and followers >= 4
                cast 'Bless'
                waitfortarget 2500
                target 'self'
                wait 750
            endif
        endif
    endif
    #Summon Creature Routine
    if skill "Necromancy" > 80 or skill "Spirit Speak" > 80
        if followers = 4 and mana > 30
            settimer "bardLock" 0
            if skill "Necromancy" > 80
                say "[VengefulSpirit"
                wait 1000
            endif
            cast 'Summ. Creature'
            wait 5000
            say "All Guard Me"
        endif   
    endif
    #camping buff
    if skill "Camping" > 50 and not findbuff "Campfire Visit"
        if not findtype "kindling" backpack
            say "Need more kindling" 
            wait 355
            say "Need more kindling" 
            wait 355
            say "Need more kindling" 
            wait 355
        endif
    
        if not findtype "campfire" true
            dclicktype "kindling" backpack
            wait 350
            while insysmsg "You fail to ignite"
                wait 3000    
                dclicktype "kindling" backpack
                wait 350
            endwhile
        endif
        wait 600
    endif
    #spirit speak only if on own boat and corpses present.  Do not SS if we have necromancy as we have liches and this is wasted time
    if skill "Spirit Speak" > 50 and timer "bardLock" > 10000 and timer "spiritSpeakCheck" > 30000 and 'boardState' = 0 and  skill "Necromancy" < 50
        if findtype 'corpse' ground any any 12 as found
            overhead "spirit speak"
            hotkey 'Spirit Speak'
            settimer "spiritSpeakCheck" 0
            settimer "bardLock" 8000
        endif
    endif
    if skill "Discordance" > 50 and timer "bardLock" > 10000 and timer "buffDisco" > 300000
        overhead "Disco Buff"
        skill "Discordance" 
        wft 2500
        targettype "backpack"
        settimer "buffDisco" 0
        settimer "bardLock" 0
    endif
    if skill "Begging" > 50  and timer "bardLock" > 10000 and timer "buffBeg" > 60000
        overhead "Begging Buff"
        skill "Begging" 
        settimer "buffBeg" 0
        settimer "bardLock" 5000
    endif
    if skill "Provocation" > 50 and timer "bardLock" > 10000 and timer "buffProvo" > 300000
        overhead "Provo Buff"
        skill "Provocation" 
        wft 2500
        targettype "backpack"
        settimer "buffProvo" 0
        settimer "bardLock" 0
    endif
    if skill "Peacemaking" > 50 and timer "bardLock" > 10000 and timer "buffPeace" > 300000
        overhead "Peace Buff"
        skill "Peacemaking" 
        wft 2500
        targettype "backpack"
        settimer "buffPeace" 0
        settimer "bardLock" 0
    endif
    #Arch Protection
    if boardState = 0 and mana > 50 and skill "Magery" > 50 and timer "bardLock" > 10000 and not findbuff "Protection"
        cast 'Arch Protection'
        waitfortarget 2500
        target 'self'
    endif
    #Bless
    if boardState = 0 and mana > 50 and skill "Magery" > 50 and timer "bardLock" > 10000 and not findbuff "Strength" 
        overhead "Mage Buff"
        cast 'Bless'
        waitfortarget 2500
        target 'self'
        wait 750
        cast 'Bless'
        waitfortarget 2500
        target 'self'
        wait 750
    endif
    if mana > 50 and skill "Magery" > 50 and timer "bardLock" > 10000 and not findbuff "Reactive Armor" and defensiveBuffs = 1
        cast 'Reactive Armor'
        wait 750
    endif
    if mana > 50 and skill "Magery" > 50 and timer "bardLock" > 10000 and not findbuff "Magic Reflection" and defensiveBuffs = 1
        cast 'Magic Reflection'
        wait 750
    endif

    if skill "Taste Identification" > 50 and timer "bardLock" > 10000 and timer "buffTaste" > 60000
        overhead "tasteidentification Buff"
        skill "tasteid"
        wft 2500
        targettype "backpack" backpack
        settimer "buffTaste" 0
        settimer "bardLock" 5000
    endif
    
    

    
    
    ###############                                                   ###############
    ###############    Start routines that do not require target      ###############
    ###############                                                   ###############   
    
    #Yell if we are not in fighting party
    if insysmsg "You must be a part of your initial embarking"
        say "Hey! I am not in the fighting party!!!" 23
        wait 500
        say "Hey! I am not in the fighting party!!!" 23
        wait 500
        say "Hey! I am not in the fighting party!!!" 23
        wait 500
    endif
    
    #Check if we broke an instrument
    if skill "Musicianship" > 50
        if insysmsg "What instrument shall you play"
            @setvar newInstrument 0 
            foreach instrumentType in 'instrumentTypes'
                if findtype instrumentType as foundInstrument
                    dclick foundInstrument              
                    @setvar newInstrument 1
                endif
            endfor
            if newInstrument = 0
                say "I am out of instruments!!!"
                wait 500
                say "I am out of instruments!!!"
                wait 500
                say "I am out of instruments!!!"
                wait 500
            endif
        endif
    endif
    
    #disco routine
    if  skill "Discordance" > 50 and timer "bardLock" > 10000 and timer "discoTimer" > 5150 and closeEnemy = 1
        overhead "Disco Target!" 33
        skill "Discordance" 
        wft 500
        target self
        settimer "discoTimer" 0
        settimer "bardLock" 4750
    endif
    
    #Necro Abilities
    if skill "Necromancy" > 80 
        #painspike
        if 'boardState' = 1 and timer "painSpkeTimer" > 35000
            if findtype 'corpse' ground any any 10 as found
                say '[painspike'
                wft 500
                target found
                wait 350
                settimer "painSpkeTimer" 0
            endif  
        #Vamp 
        elseif 'boardState' = 0  and timer "vampTimer" > 35000
            if findtype 'corpse' ground any any 10 as found
                say '[vampiricembrace' 
                wft 500
                target found
                settimer "vampTimer" 0
                wait 350
            endif    
        endif
    endif   
    #Repair Routine - 
    if 'closeEnemy' = 0 and timer "RepairHull" > 4000
        if repairLockdown = 0 or timer "repairTimer" < 120000
            say '[RepairGuns'
            wait 355            
            if insysmsg 'guns do not need'
                say '[RepairSails'
                wait 355
                if insysmsg 'sails do not need'
                    say '[RepairHull'
                endif
            endif
        endif
        settimer "RepairHull" 0
    endif    
    
    #Put on your clothes
    if timer "dressTimer" > 10000
        #Try to dress 
        dress "bow"   
        settimer "dressTimer" 0
        
        if followers > 1
            say "All guard me"
        endif   
        
        if skill "Magery" > 50
            foreach reg in 'regTypes'
                if counttype reg < 3
                    wait 500
                    say "Hey! I am Low on regs!" 23
                    wait 500
                    say "Hey! I am Low on regs!" 23
                    wait 500
                    say "Hey! I am Low on regs!" 23
                endif
            endfor
        endif
    endif
    endif
    
    ###############                                         ###############
    ###############    Start target search / embark routine ###############
    ###############                                         ###############   
    if timer "newTargetCheck" > 2500
        overhead "Target acquisition routine engage!"
        #reset timer
        settimer "newTargetCheck" 0
        @setvar searchNew 1
        if varexist 'lastserial'
            if targetLock = 1 
                if noto 'lastserial' = invulnerable 
                    sysmsg "Testing target is alive" 
                endif
                if insysmsg "not found"
                    #This status means target is dead
                    overhead "Target is dead or out of range. Finding a new one"
                else
                    #Our target appears to be alive still.  Do not hunt for a new target
                    @setvar searchNew 0             
                endif     
            endif
        endif
        
        
        if searchNew = 1 or skill "Poisoning" > 50            
            #Set this to 1 before we search
            @setvar closeEnemy 1
            #Start cycline
            hotkey 'Next Grey Monster Target'
            wait 255
            if insysmsg 'No one matching that'       
                hotkey 'Next Grey Humanoid Target'
                wait 255
                if insysmsg 'No one matching that'  
                    #Start boss hunt        
                    hotkey "Target random murderer" 
                    wait 255
                    if insysmsg 'No one matching that'  
                        #We have no target so set close enemy 0                 
                        @setvar 'closeEnemy' 0
                    else
                        #Found a boss so we want to pretend we are boarded
                        @setvar 'boardState' 1
                    endif
                endif
            endif
            
            #Set up var for last enemy.  If no enemy it is time to leave this boat
            if closeEnemy = 1       
                @setvar! 'lastserial' lasttarget
            #Embark Routine 
            elseif 'boardState' = 1         
                overhead "Done with this fight"
                
                #Skinning Routine
                if skill 'Forensic Evaluation' > 20
                    clearsysmsg             
                    #Wait on skill usage CD
                    while timer "bardLock" < 10000
                        wait 100
                    endwhile
                    for 3
                        hotkey 'Forensics'
                        wait 500
                        target 'self'
                        wait 1500
                        if not insysmsg "You carve" and not insysmsg  "anything nearby" and not insysmsg "must wait"
                            while not insysmsg "successful"
                                say "I am broken in a Captcha loop.  Fix me"
                                wait 2500
                            endwhile                                
                        endif
                    endfor 
                endif
                #Start Embarking
                hotkey 'Cancel Current Target'
                dclick tillerDude
                wait 350
                gumpresponse 21 4216593270
                wait 350
                gumpresponse 22 4216593270
                wait 350
                dclick tillerDude
                wait 350
                gumpresponse 21 4216593270
                wait 350
                gumpresponse 22 4216593270
                #we do this to make sure embark worked
                say "[embark"
                wait 500
                say "[embarkfollowers"
                wait 350
                @setvar 'boardState' 0
                settimer "repairTimer" 0
            endif
        #end enemy search routine
        endif
    endif    
    ###############                                     ###############
    ###############Start routines that  require a target###############
    ###############                                     ###############   
    
    if closeEnemy = 1    
        
        #attack routine  - Always attack so pets go aggro at least if we are not a melee class   
        attack 'lastserial'
        
        #Turn on war mode because why not
        if not warmode
            warmode on
        endif               
                
        #Remove this if you read this far.  It kills your own crew if you target my captain
        if 'lastserial' = 0x15C5E or 'lastserial' = 0x348287 or 'lastserial' = 0x2E2E1 or 'lastserial' = 0x136133
            while not dead
                hotkey 'Next Friendly Humanoid Target'
                wait 350             
                @setvar! 'lastserial' lasttarget
                attack 'lastserial'         
                if  skill "Discordance" > 50 
                    skill "Discordance" 
                    wft 2500
                    target 'lastserial'
                endif
                if skill 'Magery' > 80
                    overhead "FS!" 33
                    cast "Flamestrike"
                    wft 3500
                    target 'lastserial'
                    wait 700
                endif                   
                if  skill "Poisoning" > 50  
                    overhead "Poison Target!" 33
                    cast "Poison"
                    wft 1500
                    target 'lastserial'
                    wait 400
                    #try to poison strike
                    say "[poisonStrike"
                    wft 1500
                    target 'lastserial'
                    wait 300
                endif
                say "Well, fuck me!  I love Brozan!"
            endwhile
        endif           
                                
        #herding
        if skill 'Herding' > 50 and timer "crookCheck" > 3000
            #Wait on skill usage CD
            while timer "bardLock" < 10000
                wait 100
            endwhile
            #use a crook
            dclicktype 3713 
            wft 500
            target 'lastserial'
            settimer "crookCheck" 0
            settimer "bardLock" 7000
        endif
        if followers > 1 and timer "petAttack" > 2500
            say "All kill"
            wft 1500
            target 'lastserial'
            settimer "petAttack" 0
        endif
        
        #poison routine 
        if  skill "Poisoning" > 50 and mana >= 35
            overhead "Poison Target!" 33
            cast "Poison"
            wft 4500
            target 'lastserial'
            wait 400
            if 'boardState' = 1 and timer "poisonStrikeTimer" > 35000
                #try to poison strike
                say "[poisonStrike"
                wft 500
                target 'lastserial'
                settimer "poisonStrikeTimer" 0
            endif
            if skill "Discordance" <= 50 
                #Bump timer so we jump to a new target 
                settimer newTargetCheck 5000
            endif
        endif
        
        #Flamestrike
        if skill 'Magery' > 80 and skill 'Archery' < 80
            if counttype "Spider's Silk" > 15 and counttype "Sulfurous Ash" > 15 and 'boardState' = 1 and mana >= 51
                # put an extra ' here to fix formatting
                wait 400
                cast "Flamestrike"
                wft 3500
                target 'lastserial'
                wait 400
                say "So anyway I started blastin" 33
                wait 300
            endif
        endif   
    #end target required routines
    endif
endwhile   